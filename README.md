# 视觉对抗A入门指南

## 中国高校智能机器人创意大赛-统一部件组视觉对抗A-入门指南

## 1. 项目简介

---

### 1.1 赛规简述:

---

视觉对抗A项目是一个旨在提高机器人在机器视觉和运动控制方面的能力的比赛。参赛队伍需要在统一提供的机器人和相关部件上编写程序完成任务，并自行设计摄像头固定件和固定方式。比赛场地由三个部分组成：启动区，模拟公路和靶区。机器人需要从启动区出发，沿着模拟公路行驶，到达停止区前的停止判定区并停下，挥动手臂完成击靶，利用图像制导和机械臂运动规划，完成对靶子的打击。比赛的评分标准分为两部分，分别为完成自动驾驶和未完成自动驾驶。本赛事的目标是推动智能机器人技术在高校中的普及和发展。

### 1.2 赛道场地图

---

实景图，来自2023年比赛现场：

![1_2_1](README.assets/1_2_1.png)

规则图，来自2023年比赛规则：

![1_2_2](README.assets/1_2_2.png)

### 1.3 详细规则附件(2023版)

---

[详细规则附件](README.assets/统一部件组视觉对抗A比赛规则.pdf)

## 2. 机器人介绍

---

### 2.1 机器人外观及尺寸

---

本项目统一使用的机器人为：智元素-格斗机器人-高级版，制造商：博创尚和。

它可以通过编程或手机遥控来操控机器人的动作，实现对战等多种模式。它还可以通过安装树莓派背包来扩展机器人的功能。它的传感器系统也可以让机器人适应不同的环境和任务，如避障、寻迹、跟随等。

机器人的尺寸：高：31cm；长33cm；宽35cm；重量：3.475kg

![2_1_1](README.assets/2_1_1.png)

### 2.2 所用功能产品介绍

---

#### 2.2.1 树莓派背包

---

本项比赛所指定的树莓派型号为Raspberry Pi 3 Model B(Rev 1.2)，硬件参数如下：

| 项目   | 参数                                                   |
|------|------------------------------------------------------|
| CPU  | Broadcom BCM2837 64 位四核 ARM Cortex-A53 处理器，频率 1.2GHz |
| GPU  | Broadcom VideoCore IV @ 400 MHz                      |
| 内存   | 1GB LPDDR2 SDRAM （实际可用874M)                          |
| 网络   | 10/100/1000M以太网口，2.4GHz 802.11n 无线局域网，蓝牙4.1          |
| GPIO | 40pin扩展接口                                            |
| 视频输出 | HDMI                                                 |
| 音频输出 | 3.5mm音频输出接口                                          |
| 存储   | Micro SD 卡插槽                                         |
| USB  | 4个USB 2.0接口                                          |
| 电源   | 通过机器人背部的串口兼电源线供应                                     |

系统镜像使用博创尚和官方提供的镜像，系统信息如下：

| 项目           | 参数                      |
|--------------|-------------------------|
| Linux发行版     | Raspbian GNU/Linux 9.13 |
| Linux发行版上游   | Debian 9.13 (stretch)   |
| Linux内核版本    | 4.19.118-v7+            |
| 系统架构         | armv7l (32位arm)         |
| 包管理器         | apt                     |
| 桌面环境         | LXDE (lxde 9+rpi1)      |
| 默认shell      | bash                    |
| python版本     | 3.5.3                   |
| TensorFlow版本 | 1.14.0                  |
| OpenCV版本     | 3.4.1                   |
| Numpy版本      | 1.18.1                  |

#### 2.2.2 摄像头

---

本项比赛所指定的摄像头为OmniVision OV2659，硬件参数如下：

| 项目        | 参数                |
|-----------|-------------------|
| 传感器型号     | OmniVision OV2659 |
| 视频捕获的像素格式 | YUYV              |
| 驱动方式      | V4L2驱动            |

运行以下命令获取摄像头支持的分辨率以及相应最大帧率:

```shell
v4l2-ctl --list-formats-ext
```

| 分辨率       | 最大帧率   |
|-----------|--------|
| 640x480   | 30 fps |
| 320x240   | 30 fps |
| 160x120   | 30 fps |
| 352x288   | 30 fps |
| 176x144   | 30 fps |
| 1280x1024 | 7 fps  |
| 1600x1200 | 5 fps  |

运行以下命令获取摄像头支持的控制参数:

```shell
v4l2-ctl -l
```

| 参数                             | 翻译      | 最小值      | 最大值     | 默认值     |
|--------------------------------|---------|----------|---------|---------|
| brightness                     | 亮度      | -64      | 64      | 4       |
| contrast                       | 对比度     | 0        | 100     | 33      |
| saturation                     | 饱和度     | 0        | 100     | 37      |
| hue                            | 色调      | -2000    | 2000    | 0       |
| white_balance_temperature_auto | 自动白平衡温度 | 0(false) | 1(true) | 1(true) |
| gamma                          | 伽马      | 100      | 300     | 100     |
| power_line_frequency           | 电源频率    | 0        | 2       | 1(50Hz) |
| white_balance_temperature      | 手动白平衡温度 | 2800     | 6500    | 4600    |
| sharpness                      | 锐度      | 0        | 15      | 2       |
| backlight_compensation         | 背光补偿    | 0        | 2       | 1       |

通过对比其他摄像头的输出，可以发现摄像头缺少对曝光的控制，在其他摄像头相应的参数如下：

| 参数                | 翻译    | 最小值 | 最大值   | 默认值 |
|-------------------|-------|-----|-------|-----|
| exposure_auto     | 自动曝光  | 0   | 3     | 3   |
| exposure_absolute | 曝光绝对值 | 1   | 10000 | 156 |

该摄像头的驱动暂不支持关闭自动曝光和调整曝光时间，摄像头在面对不同光强时会自动调整曝光时间，进而影响摄像头的帧率，面对纯黑色画面时会曝光得更亮，面对纯白色画面时会曝光得更暗，摄像头不支持控制曝光的特性对后期图像处理能力提出了更高的要求。

**摄像头参数调节命令示例:**

```shell
# 摄像头设备文件/dev/video0，关闭自动白平衡，并手动设置白平衡色温为3000K
v4l2-ctl -d /dev/video0 -c white_balance_temperature_auto=0 -c white_balance_temperature=3000
```

```shell
# 摄像头设备文件/dev/video2，亮度20，对比度55，饱和度0
v4l2-ctl -d /dev/video2 -c brightness=20 -c contrast=55 -c saturation=0
```

#### 2.2.3 机械臂

---

##### 2.2.3.1 机械臂介绍

---

机器人的机械臂由四个舵机组成，每个舵机相当于一个关节，树莓派可以利用串口电源线向机器人的微控制器发送指令，微控制器就能控制舵机来执行预配置好的动作，在本次比赛中，我们需要用机械臂来完成击靶任务，具体步骤如下：

1. 在机器人的手上安装一把武器，并在武器上固定一个记号笔，笔尖伸出武器不超过40mm。
2. 机器人开始自动驾驶前，提前调整好机械臂的姿态和方向。
3. 机器人进行自动驾驶时，机械臂需要保持不动，因为机械臂的任何动作都会被裁判判定为击靶。
4. 在停止判定区停下后，控制舵机执行动作，使记号笔在靶子上留下痕迹，完成击靶。

##### 2.2.3.2 机械臂动作编辑

---

机器人的微控制器可以存储多个动作，每个动作都有一个编号，实际可用的动作为动作1、动作2、动作3、动作4。可以使用智元素-动作编辑器软件来编辑动作。

[智元素-动作编辑器下载链接](https://wwwf.lanzout.com/iHJ8j17xs2kh)    （请根据要求安装.NET Framework）

1. 配置机器人连接到和电脑的同一个局域网，或使电脑连接到机器人提供的热点(MYAP-******)。
2. 打开智元素-动作编辑器软件，点击“连接网络”按钮，如果无法连接，选择不同的IP地址或检查网络。
3. 点击“搜索机器人”按钮，选择相应的机器人，默认使用密码88888888连接。
4. 点击“动作编辑”，双击“无.MFO”文件，此时将从机器人下载动作文件，随后可以编辑动作。
5. 编辑完毕后，点击“保存动作”按钮。

##### 2.2.3.3 机械臂动作设计

---

机械臂的动作设计需要考虑以下几个方面：

1. 机械臂的动作需要在机器人停止判定区停下后执行，因此需要在机器人自动驾驶时保持不动。
2. 机械臂的姿态和方向会对机器人的重心产生轻微影响，因此需要提前调整好机械臂的姿态和方向。
3. 击靶的动作应该尽量明显，以便裁判判定。
4. 击靶的动作应该尽量提高容错率，即使在停止判定区无法精确定位靶子，也能将笔挥到靶子上。

#### 2.2.4 全向轮底盘

---

机器人自带的全向轮底盘由三个全向轮组成，每个全向轮由一个电机驱动，树莓派可以利用串口电源线向机器人的微控制器发送包含角度、速度、转向、时间的指令，微控制器进行解析后控制每个电机的转速，从而控制机器人的运动。

以下是机器人的运动控制的一个示例：

```python
# 导入机器人控制模块
from robotPi import robotPi
# 创建机器人对象
robot = robotPi()
# 机器人向前运动1秒
robot.movement.move_forward(speed=10, times=1000)
```
